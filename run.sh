#!/bin/bash
set -e
# GHCR Token ì€ Secrets ì— ì €ì¥ ë˜ì–´ìˆìŒ.

echo "========== ğŸš€ Jobmanri App Deploy Script ì‹œì‘ =========="

############################################
# 1) .env ë¡œë”© (ì„ íƒ)
############################################
if [ -f .env ]; then
  echo "[INFO] .env íŒŒì¼ì„ ë¡œë”©í•©ë‹ˆë‹¤."
  export $(grep -v '^#' .env | xargs)
else
  echo "[WARNING] .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. í™˜ê²½ë³€ìˆ˜ëŠ” OSì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤."
fi

############################################
# 2) í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ì²´í¬
############################################
if [ -z "$GHCR_PAT" ]; then
  echo "[ERROR] GHCR_PAT í™˜ê²½ë³€ìˆ˜ê°€ í•„ìš”í•©ë‹ˆë‹¤."
  exit 1
fi

############################################
# 3) GHCR ë¡œê·¸ì¸
############################################
echo "[INFO] GHCR ë¡œê·¸ì¸ ì¤‘..."
echo "$GHCR_PAT" | docker login ghcr.io -u "jobmanri" --password-stdin

############################################
# 4) ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
############################################
echo "[INFO] ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€/ì‚­ì œ..."
docker rm -f jobmanri-app || true

############################################
# 5) ìµœì‹  ì´ë¯¸ì§€ Pull
############################################
echo "[INFO] ìµœì‹  Docker ì´ë¯¸ì§€ Pull..."
docker pull ghcr.io/jobmanri/jobmanri-app:latest

############################################
# 6) ì»¨í…Œì´ë„ˆ ì‹¤í–‰
############################################
echo "[INFO] ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰..."
docker run -d \
  --name jobmanri-app \
  -p 8080:8080 \
  --env-file .env \
  ghcr.io/jobmanri/jobmanri-app:latest

############################################
# 7) ì‹¤í–‰ í™•ì¸
############################################
echo "[INFO] ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ:"
docker ps | grep jobmanri-app

echo "========== ğŸ‰ ë°°í¬ ì™„ë£Œ! =========="
